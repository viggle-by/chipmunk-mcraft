<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mcraft + ChipmunkMod</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #000;
    }
    iframe#mcraftFrame {
      border: none;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>

  <iframe
    id="mcraftFrame"
    allowfullscreen
    allow="microphone *; camera *; display-capture *; autoplay *; clipboard-write *; clipboard-read *; xr-spatial-tracking *;"
    src="">
  </iframe>

  <script type="module">
    const iframe = document.getElementById('mcraftFrame');

    // -----------------------------
    // Build iframe URL with query parameters
    // -----------------------------
    (function() {
      const baseUrl = 'https://mcraft.fun';
      const baseParams = new URLSearchParams('parentFrameMods=1');

      const currentParams = new URLSearchParams(window.location.search);
      for (const [key, value] of currentParams.entries()) {
        baseParams.set(key, value);
      }

      iframe.src = `${baseUrl}?${baseParams.toString()}`;
    })();

    // -----------------------------
    // Mod messaging constants
    // -----------------------------
    const MODS_REQUEST_MESSAGE = 'mwc:modsRequest';
    const MODS_RESPONSE_MESSAGE = 'mwc:modsResponse';

    // -----------------------------
    // Listen for mod requests from iframe
    // -----------------------------
    window.addEventListener('message', async function(event) {
      if (!event.origin.includes('mcraft.fun')) return;

      const { data } = event;

      if (data && typeof data === 'object' && data.type === MODS_REQUEST_MESSAGE) {
        const chipmunkMod = {
          name: 'chipmunkmod',
          version: '0.2.0',
          enabled: true,
          author: 'zardoy',
          scriptMainUnstable: await fetch('dist/chipmunkmod.js')
            .then(res => res.text())
            .then(text => text.replace('//# sourceURL=dist/chipmunkmod.js', '')),
        };

        iframe.contentWindow.postMessage({
          type: MODS_RESPONSE_MESSAGE,
          mods: [chipmunkMod]
        }, '*');
      }
    });
  </script>

</body>
</html>
